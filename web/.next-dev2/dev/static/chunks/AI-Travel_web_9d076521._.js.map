{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/lujinlei/Documents/code/AI-Travel-Homework/AI-Travel/web/src/components/Input.tsx"],"sourcesContent":["\"use client\";\nimport React, { forwardRef } from \"react\";\n\ntype InputProps = React.InputHTMLAttributes<HTMLInputElement> & {\n  label?: string;\n  error?: string;\n};\n\nconst Input = forwardRef<HTMLInputElement, InputProps>(\n  ({ label, error, className = \"\", ...props }, ref) => {\n    return (\n      <label className=\"block\">\n        {label && <span className=\"mb-1 block text-sm text-gray-700\">{label}</span>}\n        <input\n          ref={ref}\n          className={[\n            \"w-full rounded-md border px-3 py-2 text-sm shadow-sm\",\n            error ? \"border-red-400 focus:ring-red-500\" : \"border-gray-300 focus:ring-indigo-500\",\n            \"focus:outline-none focus:ring-2\",\n            className,\n          ].join(\" \")}\n          {...props}\n        />\n        {error && <span className=\"mt-1 block text-xs text-red-600\">{error}</span>}\n      </label>\n    );\n  }\n);\n\nInput.displayName = \"Input\";\nexport default Input;"],"names":[],"mappings":";;;;;AACA;AADA;;;AAQA,MAAM,sBAAQ,IAAA,kMAAU,OACtB,CAAC,EAAE,KAAK,EAAE,KAAK,EAAE,YAAY,EAAE,EAAE,GAAG,OAAO,EAAE;IAC3C,qBACE,oNAAC;QAAM,WAAU;;YACd,uBAAS,oNAAC;gBAAK,WAAU;0BAAoC;;;;;;0BAC9D,oNAAC;gBACC,KAAK;gBACL,WAAW;oBACT;oBACA,QAAQ,sCAAsC;oBAC9C;oBACA;iBACD,CAAC,IAAI,CAAC;gBACN,GAAG,KAAK;;;;;;YAEV,uBAAS,oNAAC;gBAAK,WAAU;0BAAmC;;;;;;;;;;;;AAGnE;;AAGF,MAAM,WAAW,GAAG;uCACL","debugId":null}},
    {"offset": {"line": 67, "column": 0}, "map": {"version":3,"sources":["file:///Users/lujinlei/Documents/code/AI-Travel-Homework/AI-Travel/web/src/components/VoiceButton.tsx"],"sourcesContent":["\"use client\";\nimport React, { useEffect, useRef, useState } from \"react\";\n\ntype VoiceButtonProps = {\n  onTranscribe?: (text: string) => void;\n  className?: string;\n};\n\ntype State = \"idle\" | \"recording\" | \"transcribing\" | \"done\" | \"error\";\n\nexport default function VoiceButton({ onTranscribe, className = \"\" }: VoiceButtonProps) {\n  const [state, setState] = useState<State>(\"idle\");\n  const [message, setMessage] = useState<string>(\"\");\n  const [mode] = useState<\"service\" | \"iflytek\" | \"browser\">(\"iflytek\");\n  const streamRef = useRef<MediaStream | null>(null);\n  const recRef = useRef<MediaRecorder | null>(null);\n  const chunksRef = useRef<BlobPart[]>([]);\n  const wsRef = useRef<WebSocket | null>(null);\n  const audioCtxRef = useRef<AudioContext | null>(null);\n  const processorRef = useRef<ScriptProcessorNode | null>(null);\n  const textRef = useRef<string>(\"\");\n  const tokensRef = useRef<string[]>([]); // 累积识别词元，支持 wpgs 动态修正\n\n  // 将 Float32 PCM 转为 16bit PCM 并 base64\n  const floatTo16kBase64 = (input: Float32Array, inputSampleRate: number, targetRate = 16000) => {\n    let samples = input;\n    if (inputSampleRate !== targetRate) {\n      const ratio = inputSampleRate / targetRate;\n      const newLength = Math.round(input.length / ratio);\n      const resampled = new Float32Array(newLength);\n      for (let i = 0; i < newLength; i++) {\n        const idx = Math.round(i * ratio);\n        resampled[i] = input[Math.min(idx, input.length - 1)];\n      }\n      samples = resampled;\n    }\n    const buffer = new ArrayBuffer(samples.length * 2);\n    const view = new DataView(buffer);\n    for (let i = 0; i < samples.length; i++) {\n      let s = Math.max(-1, Math.min(1, samples[i]));\n      view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7fff, true);\n    }\n    const u8 = new Uint8Array(buffer);\n    let binary = \"\";\n    const chunkSize = 0x8000;\n    for (let i = 0; i < u8.length; i += chunkSize) {\n      binary += String.fromCharCode.apply(null, Array.from(u8.subarray(i, i + chunkSize)) as any);\n    }\n    return btoa(binary);\n  };\n\n  const parseIatText = (msg: any) => {\n    try {\n      const ws = msg?.data?.result?.ws || [];\n      const parts: string[] = [];\n      for (const w of ws) {\n        const cw = w?.cw || [];\n        if (cw[0]?.w) parts.push(cw[0].w);\n      }\n      return parts.join(\"\");\n    } catch {\n      return \"\";\n    }\n  };\n\n  const startIflytek = async () => {\n    try {\n      const signRes = await fetch(\"/api/voice/iflytek/sign\");\n      if (signRes.status === 501) {\n        setState(\"error\");\n        setMessage(\"未配置讯飞密钥，请在 .env.local 配置 IFLYTEK_APP_ID/KEY/SECRET\");\n        return;\n      }\n      const { wsUrl, appId } = await signRes.json();\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      streamRef.current = stream;\n      // 使用默认设备采样率，避免部分浏览器不支持强制 16000 采样率\n      const AC: any = (window as any).AudioContext || (window as any).webkitAudioContext;\n      const audioCtx = new AC();\n      audioCtxRef.current = audioCtx;\n      const source = audioCtx.createMediaStreamSource(stream);\n      const processor = audioCtx.createScriptProcessor(4096, 1, 1);\n      processorRef.current = processor;\n\n      const ws = new WebSocket(wsUrl);\n      wsRef.current = ws;\n      textRef.current = \"\";\n      setState(\"recording\");\n      setMessage(\"录音中（讯飞）...\");\n\n      ws.onopen = () => {\n        // 发送开始帧\n        const startFrame = {\n          common: { app_id: appId },\n          business: {\n            language: \"zh_cn\",\n            domain: \"iat\",\n            accent: \"mandarin\",\n            // 启用动态修正以便实时返回片段\n            dwa: \"wpgs\",\n            vad_eos: 5000,\n          },\n          data: {\n            status: 0,\n            format: \"audio/L16;rate=16000\",\n            encoding: \"raw\",\n            audio: \"\",\n          },\n        };\n        ws.send(JSON.stringify(startFrame));\n\n        processor.onaudioprocess = (e: AudioProcessingEvent) => {\n          const input = e.inputBuffer.getChannelData(0);\n          const base64 = floatTo16kBase64(input, audioCtx.sampleRate, 16000);\n          const frame = {\n            data: {\n              status: 1,\n              format: \"audio/L16;rate=16000\",\n              encoding: \"raw\",\n              audio: base64,\n            },\n          };\n          ws.send(JSON.stringify(frame));\n        };\n        source.connect(processor);\n        processor.connect(audioCtx.destination);\n        tokensRef.current = [];\n      };\n\n      ws.onmessage = async (ev: MessageEvent) => {\n        try {\n          let data: any;\n          if (typeof ev.data === \"string\") {\n            data = JSON.parse(ev.data);\n          } else if (ev.data instanceof Blob) {\n            data = JSON.parse(await ev.data.text());\n          } else if (ev.data instanceof ArrayBuffer) {\n            data = JSON.parse(new TextDecoder().decode(ev.data));\n          } else {\n            data = ev.data;\n          }\n          if (data.code !== 0) {\n            setState(\"error\");\n            setMessage(data.message || \"讯飞识别错误\");\n            return;\n          }\n          const status = data?.data?.status;\n          const result = data?.data?.result || {};\n          const wsArr = result.ws || [];\n          const pgs = result.pgs; // 'apd' 追加 或 'rpl' 替换\n          const rg = result.rg || []; // [start, end] 1-based\n\n          const words: string[] = [];\n          for (const w of wsArr) {\n            const cw = w?.cw || [];\n            if (cw[0]?.w) words.push(cw[0].w);\n          }\n\n          if (words.length) {\n            if (pgs === \"rpl\" && Array.isArray(rg) && rg.length === 2) {\n              const start = Math.max(0, Number(rg[0]) - 1);\n              const end = Math.min(tokensRef.current.length, Number(rg[1]));\n              tokensRef.current.splice(start, end - start, ...words);\n            } else {\n              tokensRef.current.push(...words);\n            }\n\n            const full = tokensRef.current.join(\"\");\n            setMessage(full);\n            textRef.current = full;\n\n            if (status === 2) {\n              setState(\"done\");\n              onTranscribe?.(full);\n              try { ws.close(); } catch {}\n            }\n          }\n        } catch (e: any) {\n          setState(\"error\");\n          setMessage(e?.message || \"讯飞消息解析失败\");\n        }\n      };\n\n      ws.onerror = () => {\n        // 连接失败时提示并保持错误状态，不回退，以确保使用讯飞方案\n        try {\n          source.disconnect();\n          processor.disconnect();\n          if (audioCtx.state !== \"closed\") audioCtx.close();\n          stream.getTracks().forEach(t => t.stop());\n        } catch {}\n        setState(\"error\");\n        setMessage(\"讯飞连接错误，请检查密钥、系统时间或网络\");\n      };\n\n      ws.onclose = (ev: CloseEvent) => {\n        if (textRef.current) {\n          setState(\"done\");\n          onTranscribe?.(textRef.current);\n        } else if (state === \"recording\") {\n          // 若正在录音被关闭，则恢复为空闲\n          setState(\"idle\");\n          setMessage(\"已停止\");\n        }\n        // 清理资源\n        try {\n          source.disconnect();\n          processor.disconnect();\n          if (audioCtx.state !== \"closed\") audioCtx.close();\n          stream.getTracks().forEach(t => t.stop());\n        } catch {}\n      };\n    } catch (e: any) {\n      setState(\"error\");\n      setMessage(e?.message || \"讯飞启动失败\");\n    }\n  };\n\n  // 浏览器语音识别回退\n  const startBrowserSpeech = () => {\n    const SR: any = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;\n    if (!SR) {\n      setState(\"error\");\n      setMessage(\"浏览器不支持 Web Speech API\");\n      return;\n    }\n    const recog = new SR();\n    recog.lang = \"zh-CN\";\n    recog.continuous = false;\n    recog.interimResults = false;\n    setState(\"recording\");\n    recog.onresult = (ev: any) => {\n      const text = ev.results?.[0]?.[0]?.transcript || \"\";\n      setState(\"done\");\n      setMessage(text);\n      onTranscribe?.(text);\n    };\n    recog.onerror = (e: any) => {\n      setState(\"error\");\n      setMessage(e?.message || \"识别失败\");\n    };\n    recog.onend = () => {\n      if (state === \"recording\") setState(\"idle\");\n    };\n    recog.start();\n  };\n\n  const startRecording = async () => {\n    await startIflytek();\n  };\n\n  const stopRecording = () => {\n    // 发送结束帧（若连接已打开）\n    try {\n      if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {\n        wsRef.current.send(\n          JSON.stringify({ data: { status: 2, format: \"audio/L16;rate=16000\", encoding: \"raw\", audio: \"\" } })\n        );\n      }\n    } catch {}\n\n    // 停止音频处理与关闭连接\n    try { if (processorRef.current) { (processorRef.current as any).onaudioprocess = null; processorRef.current.disconnect(); } } catch {}\n    try { if (audioCtxRef.current && audioCtxRef.current.state !== \"closed\") { audioCtxRef.current.close(); } } catch {}\n    // 允许服务端返回最终结果，再延迟关闭 WebSocket\n    try {\n      if (wsRef.current) {\n        const ws = wsRef.current;\n        setTimeout(() => { try { if (ws.readyState === WebSocket.OPEN) ws.close(); } catch {} }, 800);\n      }\n    } catch {}\n\n    processorRef.current = null;\n    audioCtxRef.current = null;\n    wsRef.current = null;\n\n    // 停止麦克风流\n    try { streamRef.current?.getTracks().forEach((t) => t.stop()); } catch {}\n    streamRef.current = null;\n\n    // 切为“转写中”，提示稍后生成路线\n    setState(\"transcribing\");\n    setMessage(\"已停止，处理中...\");\n  };\n\n  useEffect(() => () => stopRecording(), []);\n\n  return (\n    <div className={[\"flex items-center gap-2\", className].join(\" \")}>\n      <button\n        className=\"rounded bg-black px-3 py-1.5 text-white disabled:opacity-60\"\n        onClick={state === \"recording\" ? stopRecording : startRecording}\n      >\n        {state === \"recording\" ? \"停止\" : \"语音输入\"}\n      </button>\n      {/* 固定使用讯飞识别，不展示模式选择 */}\n      <span className=\"text-xs text-zinc-500\">{message}</span>\n    </div>\n  );\n}"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 404, "column": 0}, "map": {"version":3,"sources":["file:///Users/lujinlei/Documents/code/AI-Travel-Homework/AI-Travel/web/src/app/page.tsx"],"sourcesContent":["\"use client\";\nimport { useState } from \"react\";\nimport Input from \"@/components/Input\";\nimport VoiceButton from \"@/components/VoiceButton\";\nimport { useRouter } from \"next/navigation\";\n\ntype PlanItem = { id: string; time?: string; title: string; note?: string };\ntype PlanDay = { date: string; items: PlanItem[] };\ntype PlanData = {\n  id: string;\n  destination: string;\n  start_date: string;\n  end_date: string;\n  days: PlanDay[];\n  markers?: { position: [number, number]; title?: string }[];\n  source?: \"llm\" | \"fallback\";\n};\n\nfunction parseSpecFromText(text: string) {\n  const t = text.trim();\n  const cities = [\n    \"北京\",\"天津\",\"上海\",\"重庆\",\"广州\",\"深圳\",\"杭州\",\"苏州\",\"南京\",\"武汉\",\"成都\",\"西安\",\"青岛\",\"大连\",\"沈阳\",\"长春\",\"哈尔滨\",\"济南\",\"郑州\",\"佛山\",\"宁波\",\"无锡\",\"厦门\",\"福州\",\"合肥\",\"长沙\",\"南昌\",\"昆明\",\"石家庄\",\"太原\",\"兰州\",\"呼和浩特\",\"南宁\",\"贵阳\",\"海口\",\"三亚\",\"西宁\",\"银川\",\"乌鲁木齐\"\n  ];\n  let destination = \"北京\";\n  for (const c of cities) { if (t.includes(c)) { destination = c; break; } }\n  const mCity = t.match(/([\\u4e00-\\u9fa5]+)市/);\n  if (mCity) destination = mCity[1];\n\n  const mDates = Array.from(t.matchAll(/(20\\d{2}-\\d{2}-\\d{2})/g)).map(m => m[1]);\n  const today = new Date();\n  const fmt = (d: Date) => d.toISOString().slice(0, 10);\n  let start = fmt(today);\n  let end = fmt(new Date(today.getTime() + 2 * 86400000));\n  if (mDates.length >= 2) { start = mDates[0]; end = mDates[1]; }\n  else if (mDates.length === 1) { start = mDates[0]; const d1 = new Date(mDates[0]); end = fmt(new Date(d1.getTime() + 2 * 86400000)); }\n\n  let pace: \"relaxed\" | \"standard\" | \"intense\" = \"standard\";\n  if (/悠闲|轻松|休闲|慢/.test(t)) pace = \"relaxed\";\n  if (/紧凑|高强度|赶场|多安排/.test(t)) pace = \"intense\";\n  // 预算提取（“预算5000元”、“预算：8000”、“¥6000”等）\n  let budgetTotal: number | undefined = undefined;\n  const mb = t.match(/预算[:：\\s]*([\\d,.]+)/) || t.match(/¥\\s*([\\d,.]+)/) || t.match(/([\\d,.]+)\\s*元/);\n  if (mb) {\n    const num = Number(String(mb[1]).replace(/[,]/g, \"\"));\n    if (Number.isFinite(num) && num > 0) budgetTotal = num;\n  }\n  return { destination, start_date: start, end_date: end, preferences: { pace, ...(budgetTotal ? { budgetTotal } : {}) } };\n}\n\nexport default function HomePage() {\n  const [text, setText] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const router = useRouter();\n\n  const handleStart = async () => {\n    const spec = parseSpecFromText(text);\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(\"/api/plan/create\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(spec),\n      });\n      if (!res.ok) {\n        const msg = await res.text().catch(() => \"生成失败\");\n        throw new Error(msg || \"生成失败\");\n      }\n      const data: PlanData = await res.json();\n      try { localStorage.setItem(\"lastPlan\", JSON.stringify(data)); } catch {}\n      router.push(\"/plan\");\n    } catch (e: any) {\n      setError(e?.message || \"生成失败\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"mx-auto max-w-3xl px-4 py-16\">\n      <h1 className=\"text-2xl font-semibold\">AI 旅行助手</h1>\n      <p className=\"mt-3 text-zinc-600\">一个输入框，支持语音识别；点击开始规划。</p>\n\n      {error && (\n        <div className=\"mt-4 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700\">{error}</div>\n      )}\n\n      {/* 单输入框：语音按钮内嵌到输入框右侧 */}\n      <div className=\"mt-6 relative\">\n        <Input\n          placeholder=\"例如：下周在杭州安排一个轻松的三天行程\"\n          value={text}\n          onChange={(e) => setText(e.target.value)}\n          className=\"pr-12\"\n        />\n        <div className=\"absolute right-2 top-1/2 -translate-y-1/2\">\n          <VoiceButton onTranscribe={(t) => setText(t)} />\n        </div>\n      </div>\n\n      <div className=\"mt-4\">\n        <button\n          className=\"rounded-md bg-blue-600 px-4 py-2 text-white disabled:opacity-60\"\n          onClick={handleStart}\n          disabled={loading || !text.trim()}\n        >\n          {loading ? \"生成中...\" : \"开始规划\"}\n        </button>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 638, "column": 0}, "map": {"version":3,"sources":["file:///Users/lujinlei/Documents/code/AI-Travel-Homework/AI-Travel/web/node_modules/next/navigation.js"],"sourcesContent":["module.exports = require('./dist/client/components/navigation')\n"],"names":[],"mappings":"AAAA,OAAO,OAAO","ignoreList":[0],"debugId":null}}]
}