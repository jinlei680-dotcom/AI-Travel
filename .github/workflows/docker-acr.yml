name: Build and Push Docker Image to Aliyun ACR

on:
  push:
    branches: [ "main" ]
    tags: [ "v*", "release-*" ]
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/${{ secrets.ACR_REPOSITORY }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU (for multi-arch support)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate required secrets and show target image
        shell: bash
        run: |
          missing=0
          check() { if [ -z "$1" ]; then echo "::error::Missing required secret: $2"; missing=1; fi; }
          check "${{ secrets.ACR_REGISTRY }}" "ACR_REGISTRY"
          check "${{ secrets.ACR_NAMESPACE }}" "ACR_NAMESPACE"
          check "${{ secrets.ACR_REPOSITORY }}" "ACR_REPOSITORY"
          check "${{ secrets.ACR_USERNAME }}" "ACR_USERNAME"
          check "${{ secrets.ACR_PASSWORD }}" "ACR_PASSWORD"
          echo "Image target (constructed): ${{ env.IMAGE_NAME }}"
          if [ "$missing" = 1 ]; then
            echo "One or more required secrets are missing. Please set all ACR_* secrets in repository Settings → Secrets and variables → Actions."
            exit 1
          fi

      - name: Login to Aliyun ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract Docker metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          # Generate tags: latest on main, semver if tag, and sha
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./web
          file: ./web/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Export image as tar (for direct download)
        if: ${{ always() }}
        shell: bash
        run: |
          set -e
          echo "Selecting primary tag from metadata..."
          PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "Primary tag: ${PRIMARY_TAG}"
          if [ -z "$PRIMARY_TAG" ]; then
            echo "No tag found from metadata; skip export"
            exit 0
          fi
          echo "Pulling image $PRIMARY_TAG"
          docker pull "$PRIMARY_TAG"
          TAR_NAME="ai-travel-web-image.tar"
          echo "Saving image to $TAR_NAME"
          docker save -o "$TAR_NAME" "$PRIMARY_TAG"
          echo "Saved image tar: $TAR_NAME"

      - name: Upload image tar artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: ai-travel-web-image
          path: ai-travel-web-image.tar
          if-no-files-found: warn

      - name: Diagnostic - plain docker build without push (show logs)
        if: ${{ always() }}
        shell: bash
        run: |
          export DOCKER_CLI_HINTS=false
          export BUILDKIT_PROGRESS=plain
          echo "Running diagnostic docker build to show detailed Next.js logs..."
          docker build --pull --no-cache --progress=plain -t local-test -f ./web/Dockerfile ./web || true